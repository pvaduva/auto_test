#!/usr/bin/env expect-lite

# How to use this expect-lite file, Lines that begin with:
#       '>' send to remote host, implies "wait for prompt"
#       '<' _MUST_ be received from the remote host, or this config script will fail
#       # are comment lines, and have no effect
#       ; are printable (in stdout) comments, and have no other effect
#       @ change the expect timeout value
#       ! Embedded Expect commands
# For more info see: expect-lite.html

#
#       
#       
#
#
;;;

Auto Scaling VM

Script can also be used as a scaling test:
        ./test_5000_change_tenant_password.elt  HOST_IP=env.NODE.target.default.targetIP TENANT=tenant1
Assumptions:
        Lab is setup with lab_setup.sh with Tenants
        heat template available in the switch

;;;



*NOFAIL
*EXP_INFO

# Variables defined to be used as contants
$HOST_IP=128.224.151.244
$HOST_USER=wrsroot
$PASS=li69nux


$tenant_credentials=/home/wrsroot/openrc.$TENANT
$tenant=$tenant_credentials
# trim to just last part
=$tenant;.*[.](\w+);\1;

$lab_setup=yes

>date +%F_%T
+$DATE=\n(2.+)

@25

; === connecting to controller

>ssh -X -o UserKnownHostsFIle=/dev/null -o StrictHostKeyChecking=no $HOST_USER@$HOST_IP
-<WARNING: REMOTE HOST IDENTIFICATION HAS CHANGED
<ssword:
>>$PASS
>export TMOUT=0

; === become admin
>source /etc/nova/openrc

; === show version
>system show
>cat /etc/build.info

; === show system status
>nova service-list

; === Update tenant password
; === become admin to change tenant password
>source /etc/nova/openrc
>keystone user-password-update --pass tenantnew $tenant
>echo $?
<0

; === change openrc.tenant1 file with updated password
>sed -i "s/OS_PASSWORD=tenant1/OS_PASSWORD=tenantnew/g" $tenant_credentials

; === switch to tenant mode
>source $tenant_credentials


