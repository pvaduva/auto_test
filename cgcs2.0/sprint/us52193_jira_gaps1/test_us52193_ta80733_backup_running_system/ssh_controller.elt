#!/usr/bin/env expect-lite

# How to use this expect-lite file, Lines that begin with:
#	'>' send to remote host, implies "wait for prompt"
#	'<' _MUST_ be received from the remote host, or this config script will fail
#	# are comment lines, and have no effect
#	; are printable (in stdout) comments, and have no other effect
#	@ change the expect timeout value
#	! Embedded Expect commands
# For more info see: expect-lite.html
;;;
#
#	ssh to controller
#

To install:
./ssh_controller.elt install_sw=yes

;;;

*NOFAIL

$IP=10.10.10.3
$user=root
$pass=root
$user=wrsroot
$pass=li69nux

$hp380=no
$install_sw=no

# url used for wget
$url=10.10.10.1
$proxy_port=80

# support custom ports
?if $PORT != $blank ? $ssh_opts= -p $PORT 



?if $install_sw !=no? [
	@2
	; === start socat proxy
	>which socat
	</usr/bin/socat
	>socat TCP4-listen:8080,fork,reuseaddr TCP4:128.224.144.158:80 &
	>>
	$proxy_port=8080
]



; === connecting to controller

@20
>ssh -X $ssh_opts -o UserKnownHostsFIle=/dev/null -o StrictHostKeyChecking=no $user@$IP
-<WARNING: REMOTE HOST IDENTIFICATION HAS CHANGED
<ssword:
>>$pass

>export TMOUT=0

@3
; === set up sudo root access (to make it easier later in the interact session)
>echo "$pass" | sudo -S id
<root

; === show version

>source /etc/nova/openrc 

; === show version

>system show
>system sda-list
>cat /etc/build.info

; === show system status

>nova service-list
>system host-list

?if $hp380!=no? [
	# add board management info to HP 380 Lab
	$bm_user=Administrator
	$bm_pass=remoteADMIN

	; === add Board Management to HP 380 Lab

	>system host-update controller-0 bm_mac=b4:b5:2f:ee:ae:78 bm_type=ilo4
	>system host-update controller-0 bm_username=$bm_user bm_password=$bm_pass

	>system host-update controller-1 bm_mac=b4:b5:2f:ee:af:76 bm_type=ilo4
	>system host-update controller-1 bm_username=$bm_user bm_password=$bm_pass

	>system host-update compute-0 bm_mac=b4:b5:2f:ee:ae:90 bm_type=ilo4
	>system host-update compute-0 bm_username=$bm_user bm_password=$bm_pass

	>system host-update compute-1 bm_mac=b4:b5:2f:ee:ae:7e bm_type=ilo4
	>system host-update compute-1 bm_username=$bm_user bm_password=$bm_pass

	; === look at host
	>system host-show compute-1
]

?if $install_sw !=no? [
	# controllers don't have correct DNS :( must use IP addresses
	$my_subnet=$IP
	=$my_subnet/(\d+)\..*/\1
	?if $my_subnet == 10? $url=10.10.10.1 :: [
		$proxy=80
		$url=128.224.144.158
	]
	
	$sw=expect-lite
	>cd /tmp/
	; === place software on system
	# no longer needed
#	>if [ ! -e $sw ]; then wget  http://$url:$proxy_port/files/SW/$sw; fi
#	>chmod 755 $sw
#	>sudo cp $sw /usr/bin/
#	; === get logcapture
	$sw=logcapture.py
	>if [ ! -e $sw ]; then wget  http://$url:$proxy_port/files/SW/$sw; fi
	>sudo cp $sw /usr/lib64/python2.7/site-packages/nose/plugins/
	>cd
	; === place install files/images on controller
	@40
	>wget -r --no-parent  -nd -nH  --reject "index.html*" --reject "*new_query_string" http://$url:$proxy_port/files/install/
	>
	>
	@5
	>mkdir images
	>mv *img images/
	>chmod 755 ./lab_setup.sh
	>
	; === set up ssh keys
	>ssh-keygen -t dsa -f /home/wrsroot/.ssh/id_rsa -N "" -q
	>nova keypair-add --pub_key ~/.ssh/id_rsa.pub controller-0
]
>


*INTERACT

>
